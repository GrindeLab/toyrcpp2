---
title: "Creating an Rcpp Package"
author: "Kelsey Grinde"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  rmarkdown::html_vignette: 
    toc: true
vignette: >
  %\VignetteIndexEntry{creating-rcpp-package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(toyrcpp2)
```

# Step 1: Create the package

`File` > `New Project` > `New Directory` > `R Package` > enter name > check `Create a git repository` > `Create Project`

This creates: 

- .gitignore
-.Rbuildignore
- DESCRIPTION
- man/ directory
- NAMESPACE
- R/ directory
- toyrcpp2.Rproj

# Step 2: Initial commit

`Git` > `Commit` > select all files > type a short `Commit message` > `Commit` 

# Step 3: Publish to GitHub

Using GitHub Desktop: `File` > `Add local repository` > `Choose` > find your package in file explorer > `Add repository` > `Publish repository` > enter the name of your package > uncheck the `Keep this code private` box (if you want your repo to be public) > change the `organization` from "None" to "GrindeLab" (if you want to publish on the GrindeLab page instead of your own) > `Publish Repository`

# Step 4: Add a function

Create a new file called `R/timesTwoR.R`, which contains a simple function with roxygen comments:

```
#' Multiply by two (R version).
#'
#' This function multiplies numbers by two.
#'
#' @param x Numeric vector
#'
#' @return A numeric vector that is double the input vector
#'
#' @examples
#' timesTwoR(2)
#' timesTwoR(1:3)
#'
#' @export
timesTwoR <- function(x) {
  x * 2
}
```

# Step 5: Delete the original NAMESPACE

When we created an R package in Step 1, a `NAMESPACE` file was automatically created for us. Unfortunately, this file is not compatible with the workflow we will use in later steps. So, we need to delete the original file; a new one (that we can edit with roxygen) will be created for us in the next step.

# Step 6: Document the function

Run

```{r, eval = FALSE}
devtools::document()
```

This should do the following:

- add "RoxygenNote: 7.1.1" to `DESCRIPTION`
- create new `NAMESPACE` file: "# Generated by roxygen2: do not edit by hand\n\nexport(timesTwoR)"
- create `man/timesTwoR.Rd`

# Step 7: Delete unnecessary files

When we created an R package in Step 1, two files (`R/hello.R` and `man/hello.Rd`) were created that we really don't need. Delete these now. 

# Step 8: Install

Run 

```{r, eval = FALSE}
devtools::install()
```

# Step 9: Check

Run 

```{r, eval = FALSE}
devtools::check()
````

# Step 10: Create a vignette

Run

```{r, eval = FALSE}
usethis::use_vignette("creating-rcpp-package")
```

This should:

- add "inst/doc" to `.gitignore`
- add knitr and rmarkdown to `Suggests` and add knitr to `VignetteBuilder` fields in the `DESCRIPTION`
- create a `vignettes/.gitignore` file
- draft a vignette `vignettes/creating-rcpp-package.Rmd`

# Step 11: Update the vignette

First, update the YAML header:

```
---
title: "Creating an Rcpp Package"
author: "Kelsey Grinde"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  rmarkdown::html_vignette: 
    toc: true
vignette: >
  %\VignetteIndexEntry{creating-rcpp-package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

Then continue to edit the `.Rmd` file and `Knit` as you would with any other RMarkdown file.

# Step 12: Check the vignette

To check what the vignette looks like, you first need to build the package:

```{r, eval = FALSE}
devtools::build()
```

This will create a `.tar.gz` file in the parent directory of this project. 

From here, try browsing for vignettes:

```{r, eval = FALSE}
# look for all vignettes associated with this package
browseVignettes(package = "toyrcpp2")

# look for a specific vignette called "creating-rcpp-package"
vignette(topic = "creating-rcpp-package", package = "toyrcpp2")
```

If you get a message saying `No vignettes found...`, then you'll want to try installing the package from the `.tar.gz` file you created, above. To do this, click `Packages` > `Install` > change `Install from:` to "Package Archive File (.zip; .tar.gz)" > find the "pkgname_versionnumber.tar.gz" file > click `Install`. Then try browsing for vignettes again. 

# Step 13: Set up the package with Rcpp

Run `usethis::use_rcpp()`. 

Then, create a new file `R/toyrcpp2-package.R` that contains the following roxygen comments:

```
## usethis namespace: start
#' @useDynLib toyrcpp2, .registration = TRUE
## usethis namespace: end
NULL
## usethis namespace: start
#' @importFrom Rcpp sourceCpp
## usethis namespace: end
NULL
```

# Step 14: Add a C++ function

To add a new C++ function, create a file `src/timesTwoCpp.cpp`. Enter the following:


```
#include <Rcpp.h>
using namespace Rcpp;

// This is a simple example of exporting a C++ function to R. You can
// source this function into an R session using the Rcpp::sourceCpp
// function (or via the Source button on the editor toolbar). Learn
// more about Rcpp at:
//
//   http://www.rcpp.org/
//   http://adv-r.had.co.nz/Rcpp.html
//   http://gallery.rcpp.org/
//
// After you process with sourceCpp, you can run the R code timesTwoCpp(42)

// [[Rcpp::export]]
NumericVector timesTwoCpp(NumericVector x) {
  return x * 2;
}
```

Document:

```{r, eval = FALSE}
devtools::document()
```

This will update the `NAMESPACE` (adding `importFrom` and `useDynLib` from the roxygen comments we added in Step 13) and create `R/RcppExports.R` and `src/RcppExports.cpp` files.

Next, build and reload the package:

```{r, eval = FALSE}
devtools::build()
```

and run `timesTwoCpp(455)` in the console and check that it works.


# Step 15: Document the C++ function

Each exported C++ function gets a wrapper function, located in `R/RcppExports.R`, that is automatically created using the process we went through in Step 14. For example, the `timesTwoCpp` function that we ran above is the R wrapper function for the C++ code that we wrote. 

We can document this function using roxygen comments just like with usual R functions. The only distinction is that we'll use `//'` instead of `#'` to start each comment. For example, add roxygen comments to the `src/timesTwoCpp.cpp` file as follows:


```
#include <Rcpp.h>
using namespace Rcpp;

// This is a simple example of exporting a C++ function to R. You can
// source this function into an R session using the Rcpp::sourceCpp
// function (or via the Source button on the editor toolbar). Learn
// more about Rcpp at:
//
//   http://www.rcpp.org/
//   http://adv-r.had.co.nz/Rcpp.html
//   http://gallery.rcpp.org/
//
// After you process with sourceCpp, you can run the R code timesTwoCpp(42)

//' Multiply by two (Rcpp version)
//'
//' This function multiples numbers by two, using C++ code.
//'
//' @param x Numeric vector.
//'
//' @return A numeric vector that is double the input vector
//' @export
// [[Rcpp::export]]
NumericVector timesTwoCpp(NumericVector x) {
  return x * 2;
}
```

Run

```{r, eval = FALSE}
devtools::document()
```

This should do the following:

- add "export(timesTwoCpp)" to `NAMESPACE`
- add roxygen comments to `R/RcppExports.R`
- create `man/timesTwoCpp.Rd`


# Final Steps

1. Build: 

```{r, eval = FALSE}
devtools::build()
```

2. Install:

```{r, eval = FALSE}
devtools::install()
```

3. Check: 

```{r, eval = FALSE}
devtools::check()
````
4. Look at vignettes: 

```{r, eval = FALSE}
browseVignettes(package = "toyrcpp2")
```
